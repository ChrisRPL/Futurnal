---
globs: src/futurnal/extraction/**,tests/extraction/**
description: Temporal extraction rules - CRITICAL for Option B and Phase 3
---
# Temporal Extraction Rules

**FATAL GAP**: Without temporal extraction, Phase 3 causal inference is impossible. Temporal metadata is non-negotiable.

## Core Requirements

### 1. All Events Must Have Timestamps
**Every event entity MUST capture temporal metadata:**

```python
class Event(BaseModel):
    """Event entity with REQUIRED temporal grounding."""
    id: str
    name: str
    event_type: EventType

    # REQUIRED temporal metadata
    timestamp: datetime  # When did this occur?
    duration: Optional[timedelta] = None  # How long?

    # Context
    description: str
    participants: List[str] = []

    # Provenance
    source_document: str
    extraction_confidence: float
```

### 2. Temporal Relationship Types (7 Required)
**All temporal relationships must be classified:**

```python
class TemporalRelationType(str, Enum):
    """7 temporal relationship types from Allen's Interval Algebra."""
    BEFORE = "before"      # Event A ends before Event B starts
    AFTER = "after"        # Event A starts after Event B ends
    DURING = "during"      # Event A occurs within Event B
    CONTAINS = "contains"  # Event A contains Event B
    OVERLAPS = "overlaps"  # Events partially overlap
    SIMULTANEOUS = "simultaneous"  # Events occur at same time
    CAUSES = "causes"      # Event A causes Event B (temporal + causal)
```

### 3. Temporal Triple Structure
**Standard triple format with temporal metadata:**

```python
class TemporalTriple(BaseModel):
    """Triple with temporal metadata."""
    subject: Entity
    predicate: Relationship
    object: Entity

    # Temporal metadata (REQUIRED)
    timestamp: datetime              # When did this relationship hold?
    duration: Optional[timedelta]    # How long?
    temporal_type: TemporalRelationType
    valid_from: datetime
    valid_to: Optional[datetime]

    # Provenance
    provenance: ChunkReference
    confidence: float
```

## Implementation Guidelines

### Temporal Marker Extraction
**Extract both explicit and relative timestamps:**

```python
class TemporalMarkerExtractor:
    """Extract temporal markers from text."""

    def extract_explicit_timestamps(self, text: str) -> List[datetime]:
        """Extract ISO 8601, dates, times."""
        # "2024-01-15", "January 15, 2024", "3:00 PM"
        pass

    def extract_relative_timestamps(self, text: str, reference: datetime) -> List[datetime]:
        """Extract relative expressions."""
        # "yesterday", "last week", "2 weeks ago"
        pass
```

**Target accuracy**: >95% explicit, >85% relative

### Temporal Relationship Detection
**Classify relationships between events:**

```python
class TemporalRelationshipDetector:
    """Detect temporal relationships."""

    def detect_explicit_relationships(self, text: str) -> List[TemporalRelation]:
        """Find explicit temporal language."""
        # "before", "after", "during", "caused"
        pass

    def infer_contextual_relationships(
        self,
        event1: Event,
        event2: Event,
        context: str
    ) -> Optional[TemporalRelationType]:
        """Infer temporal ordering from context."""
        pass
```

**Target accuracy**: >80% explicit, >70% implicit

### Temporal Consistency Validation
**Ensure no temporal contradictions:**

```python
def validate_temporal_consistency(events: List[Event]) -> bool:
    """Validate temporal ordering consistency.

    Rules:
    - If A BEFORE B and B BEFORE C, then A BEFORE C (transitivity)
    - No cycles in BEFORE/AFTER relationships
    - CAUSES requires BEFORE (causal ordering)
    """
    # Build temporal graph
    graph = build_temporal_graph(events)

    # Check for cycles
    if has_cycles(graph):
        return False

    # Validate transitive closure
    if not validate_transitivity(graph):
        return False

    return True
```

**Target**: 100% consistency (no contradictions)

## Event vs Entity Distinction

### Events (Temporal)
**Characteristics:**
- Have timestamp (when it occurred)
- May have duration
- Involve participants (entities)
- Can cause other events
- Examples: Meeting, Decision, Publication, Action

### Static Entities (Non-Temporal)
**Characteristics:**
- No inherent timestamp
- Persistent over time
- Can participate in events
- Examples: Person, Organization, Concept

**CRITICAL**: Don't treat events as static entities. Events are first-class temporal objects.

## Temporal Query Support

**PKG storage must support temporal queries:**

```cypher
// Find events in time range
MATCH (e:Event)
WHERE e.timestamp >= $start AND e.timestamp <= $end
RETURN e

// Find events before/after reference
MATCH (e1:Event)-[:BEFORE]->(e2:Event)
WHERE e2.id = $reference_event
RETURN e1

// Find causal chains
MATCH path = (start:Event)-[:CAUSES*1..5]->(end:Event)
WHERE start.id = $start_event
RETURN path
```

## Testing Requirements

```python
class TestTemporalExtraction:
    def test_timestamp_extraction(self):
        """Validate timestamp extraction >95% accuracy."""
        accuracy = measure_timestamp_accuracy(test_corpus)
        assert accuracy > 0.95

    def test_temporal_relationship_detection(self):
        """Validate relationship detection >80% accuracy."""
        accuracy = measure_relationship_accuracy(test_corpus)
        assert accuracy > 0.80

    def test_temporal_consistency(self):
        """Validate no temporal contradictions."""
        events = extract_events(test_corpus)
        assert validate_temporal_consistency(events)

    def test_event_vs_entity_distinction(self):
        """Validate events separated from static entities."""
        result = extract_all(test_document)
        events = [e for e in result if isinstance(e, Event)]
        entities = [e for e in result if isinstance(e, Entity)]

        # All events have timestamps
        assert all(e.timestamp for e in events)
        # Entities may not
        assert not all(hasattr(e, 'timestamp') for e in entities)
```

## References

- **Temporal Extraction Module**: [docs/phase-1/entity-relationship-extraction-production-plan/01-temporal-extraction.md](mdc:docs/phase-1/entity-relationship-extraction-production-plan/01-temporal-extraction.md)
- **Causal Structure**: [docs/phase-1/entity-relationship-extraction-production-plan/05-causal-structure.md](mdc:docs/phase-1/entity-relationship-extraction-production-plan/05-causal-structure.md)
- **PKG Temporal Support**: [docs/phase-1/pkg-graph-storage-production-plan/04-temporal-query-support.md](mdc:docs/phase-1/pkg-graph-storage-production-plan/04-temporal-query-support.md)
