---
globs: src/futurnal/**,tests/**
description: Production plan compliance rules - Follow module-by-module implementation
---
# Production Plan Compliance Rules

**Every implementation must follow the production plan modules.** No skipping steps, no shortcuts.

## Production Plan Structure

All Phase 1 features have production plans in `docs/phase-1/*-production-plan/`:

- **Entity-Relationship Extraction** (6 modules, 5 months)
- **PKG Graph Storage** (5 modules, 4-5 weeks)
- **Vector Embedding Service** (6 modules, 6 weeks)
- **Hybrid Search API** (6 modules, 6 weeks)
- Plus 6 more features with existing plans

## Module Completion Criteria

### Each Module Requires:
1. **Implementation** - Code following production plan specifications
2. **Testing** - Unit, integration, performance tests from plan
3. **Success Metrics** - Quality gates validated
4. **Documentation** - Code comments, API docs
5. **Review** - Code review checklist completed

### Module Completion Template:

```python
# Module: 01-temporal-extraction

# 1. Implementation âœ…
class TemporalMarkerExtractor:
    """Implementation from production plan."""
    # Code matches production plan spec
    pass

# 2. Testing âœ…
class TestTemporalExtraction:
    def test_timestamp_accuracy(self):
        """From production plan testing strategy."""
        accuracy = measure_timestamp_accuracy(test_corpus)
        assert accuracy > 0.95  # Production plan target

# 3. Success Metrics âœ…
def validate_module_completion():
    return {
        "temporal_accuracy": measure_temporal_accuracy() > 0.85,  # From plan
        "tests_passing": run_tests() == "pass",
        "code_reviewed": True
    }

# 4. Documentation âœ…
"""
Module 01: Temporal Extraction

Implements temporal marker extraction and relationship detection
as specified in production plan.

Success Metrics:
- Temporal accuracy >85%
- >95% explicit timestamp detection
- >85% relative expression parsing
"""

# 5. Review âœ…
# Code review checklist from production plan completed
```

## Implementation Sequence

### Current Status (from docs/phase-1/overview.md):

**âœ… Complete:**
1. Local Files Connector
2. Obsidian Vault Connector
3. IMAP Email Connector
4. GitHub Repository Connector
5. Ingestion Orchestrator
6. Document Normalization Pipeline

**ðŸŽ¯ Next (In Order):**
7. **Entity & Relationship Extraction** â† START HERE
   - Module 01: Temporal Extraction (Weeks 1-3)
   - Module 02: Schema Evolution (Weeks 5-6)
   - Module 03: Experiential Learning (Weeks 9-11)
   - Module 04: Thought Templates (Weeks 7-8)
   - Module 05: Causal Structure (Weeks 13-14)
   - Module 06: Integration Testing (Weeks 15-16)

8. **PKG Graph Storage** (After extraction pipeline operational)
9. **Vector Embedding Service** (Can run in parallel with extraction)
10. **Hybrid Search API** (After PKG + Embeddings)

## Module Dependency Rules

### DO NOT Skip Dependencies:
```python
# âŒ WRONG - Skipping temporal extraction
def extract_entities(doc: Document) -> List[Entity]:
    # "We'll add temporal later"
    entities = extract_without_temporal(doc)
    return entities

# âœ… CORRECT - Temporal from day 1
def extract_entities(doc: Document) -> List[Entity]:
    # Temporal metadata captured immediately
    entities = extract_with_temporal(doc)
    assert all(hasattr(e, 'timestamp') for e in entities if isinstance(e, Event))
    return entities
```

### Respect Module Sequencing:
```python
# âŒ WRONG - Implementing experiential learning before temporal
class ExtractionPipeline:
    def __init__(self):
        self.experiential = ExperientialLearning()  # Module 03
        # But temporal extraction (Module 01) not implemented yet

# âœ… CORRECT - Follow module order
class ExtractionPipeline:
    def __init__(self):
        self.temporal = TemporalExtractor()  # Module 01 first
        self.schema = SchemaEvolution()      # Module 02
        # ... then experiential learning
```

## Code-Plan Alignment

### Production Plan Specifications Must Match Code:

**From Plan:**
```python
# docs/phase-1/entity-relationship-extraction-production-plan/01-temporal-extraction.md

class TemporalMarkerExtractor:
    """Extract temporal markers from text."""

    def extract_explicit_timestamps(self, text: str) -> List[datetime]:
        """
        Extract ISO 8601, dates, times.

        Target accuracy: >95%
        """
        pass
```

**In Code:**
```python
# src/futurnal/extraction/temporal.py

class TemporalMarkerExtractor:
    """Extract temporal markers from text."""

    def extract_explicit_timestamps(self, text: str) -> List[datetime]:
        """
        Extract ISO 8601, dates, times.

        Implements specification from:
        docs/phase-1/entity-relationship-extraction-production-plan/01-temporal-extraction.md

        Target accuracy: >95% (from production plan)
        """
        # Implementation matches plan specification
        pass
```

## Success Metrics Tracking

### Track Metrics from Production Plans:

```python
class ModuleSuccessMetrics:
    """Track success metrics from production plans."""

    def __init__(self):
        self.metrics = {}

    def record_module_completion(self, module: str, metrics: dict):
        """
        Record module completion metrics.

        Metrics must match production plan targets.
        """
        self.metrics[module] = {
            "completed": True,
            "metrics": metrics,
            "plan_reference": f"docs/phase-1/*-production-plan/{module}.md"
        }

    def validate_against_plan(self, module: str) -> bool:
        """Validate metrics meet production plan targets."""
        if module == "01-temporal-extraction":
            return (
                self.metrics[module]["metrics"]["temporal_accuracy"] > 0.85 and
                self.metrics[module]["metrics"]["explicit_accuracy"] > 0.95 and
                self.metrics[module]["metrics"]["relative_accuracy"] > 0.85
            )
        # ... other modules
```

## Testing Strategy from Plans

### Implement Tests Exactly as Specified:

**Plan Specification:**
```python
# From production plan testing strategy

class TestTemporalExtraction:
    def test_timestamp_extraction(self):
        """Validate timestamp extraction >95% accuracy."""
        accuracy = measure_timestamp_accuracy(test_corpus)
        assert accuracy > 0.95
```

**Implementation:**
```python
# tests/extraction/test_temporal.py

class TestTemporalExtraction:
    """Tests from production plan testing strategy."""

    def test_timestamp_extraction(self):
        """
        Validate timestamp extraction >95% accuracy.

        From: docs/phase-1/entity-relationship-extraction-production-plan/
              01-temporal-extraction.md - Testing Strategy
        """
        accuracy = measure_timestamp_accuracy(test_corpus)
        assert accuracy > 0.95, f"Accuracy {accuracy} below 95% target"
```

## Quality Gates Before Module Completion

**Module is NOT complete until:**
- âœ… All code from production plan implemented
- âœ… All tests from production plan passing
- âœ… All success metrics from production plan validated
- âœ… Code review checklist completed
- âœ… Documentation updated

## References

- **Production Plans**: [docs/phase-1/*-production-plan/](mdc:docs/phase-1/)
- **Implementation Order**: [docs/phase-1/overview.md](mdc:docs/phase-1/overview.md)
- **Option B Roadmap**: [docs/phase-1/PHASE-1-OPTION-B-ROADMAP.md](mdc:docs/phase-1/PHASE-1-OPTION-B-ROADMAP.md)
