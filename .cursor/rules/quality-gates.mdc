---
globs: tests/**,src/futurnal/**
description: Quality gate enforcement for Option B production readiness
---
# Quality Gates & Testing Requirements

**All quality gates must pass before production deployment.** These gates ensure Option B requirements are met.

## Quality Gate Targets

### Temporal Extraction Quality
- **Temporal accuracy**: >85% (explicit + relative timestamps)
- **Relationship detection**: >80% explicit, >70% implicit
- **Temporal consistency**: 100% (no contradictions)
- **Coverage**: All events have timestamps

**Testing**:
```python
def test_temporal_accuracy():
    """Validate >85% temporal extraction accuracy."""
    accuracy = measure_temporal_accuracy(test_corpus)
    assert accuracy > 0.85
```

### Schema Evolution Quality
- **Semantic alignment**: >90% vs manual schema
- **Reflection triggers**: Every N documents (N=50 typical)
- **Schema versioning**: Operational and tracked
- **Multi-phase extraction**: All 3 phases functional

**Testing**:
```python
def test_schema_evolution_alignment():
    """Validate >90% schema alignment."""
    alignment = compute_semantic_alignment(evolved_schema, manual_schema)
    assert alignment > 0.90
```

### Extraction Quality
- **Precision**: ≥0.8
- **Recall**: ≥0.7
- **Confidence threshold**: ≥0.7 for production triples
- **Learning improvement**: Measurable over 50+ documents

**Testing**:
```python
def test_extraction_precision():
    """Validate precision ≥0.8."""
    precision = measure_precision(extraction_pipeline, labeled_corpus)
    assert precision >= 0.8

def test_learning_improvement():
    """Validate quality improves over time."""
    quality_0_10 = measure_quality(docs[0:10])
    quality_40_50 = measure_quality(docs[40:50])
    assert quality_40_50 > quality_0_10
```

### Performance Quality
- **Throughput**: >5 documents/second
- **Memory usage**: <2GB for extraction pipeline
- **Latency**: <2s per document
- **Batch processing**: >100 documents/minute

**Testing**:
```python
def test_throughput_target():
    """Validate >5 docs/sec throughput."""
    throughput = measure_throughput(extraction_pipeline, 100)
    assert throughput > 5.0

def test_memory_usage():
    """Validate <2GB memory usage."""
    memory_used = measure_memory_usage(extraction_pipeline)
    assert memory_used < 2.0  # GB
```

### Experiential Learning Quality
- **Ghost frozen**: No parameter updates
- **Experiential knowledge**: Stored as token priors
- **Quality progression**: Demonstrable improvement
- **Semantic advantages**: Extracted and applied

**Testing**:
```python
def test_ghost_model_frozen():
    """Validate Ghost model parameters unchanged."""
    params_before = get_model_parameters(ghost_model)
    run_experiential_learning(ghost_model, 100)
    params_after = get_model_parameters(ghost_model)
    assert params_before == params_after

def test_quality_progression():
    """Validate experiential learning improves quality."""
    baseline = measure_quality_without_experience()
    with_experience = measure_quality_with_experience()
    assert with_experience > baseline
```

### Causal Structure Quality
- **Event extraction**: >80% accuracy
- **Event-event relationships**: Identified and flagged
- **Temporal ordering**: 100% valid (cause before effect)
- **Bradford Hill criteria**: Metadata prepared

**Testing**:
```python
def test_event_extraction_accuracy():
    """Validate >80% event extraction accuracy."""
    accuracy = measure_event_extraction_accuracy(test_corpus)
    assert accuracy > 0.80

def test_temporal_ordering_validation():
    """Ensure cause always precedes effect."""
    causal_candidates = extract_causal_candidates(test_corpus)
    assert all(c.temporal_ordering_valid for c in causal_candidates)
```

## Integration Testing Requirements

### End-to-End Pipeline Tests
**Required**: Full pipeline validation from normalization to PKG storage

```python
class TestFullPipeline:
    def test_normalized_document_to_pkg(self):
        """Validate: normalization → extraction → PKG."""
        doc = load_test_document()
        normalized = normalize_document(doc)
        entities = extract_entities(normalized)
        relationships = extract_relationships(normalized, entities)
        events = extract_events(normalized)
        causal_candidates = detect_causal_relationships(events)

        pkg.store_triples(entities + relationships + events + causal_candidates)

        assert pkg.count_entities() > 0
        assert pkg.count_events() > 0
        assert all(t.timestamp for t in events)
```

### Multi-Document Learning Tests
**Required**: Validate learning progression across documents

```python
def test_multi_document_learning():
    """Validate learning progression."""
    docs = load_test_corpus(50)

    precision_0_10 = measure_precision(pipeline, docs[0:10])
    precision_10_20 = measure_precision(pipeline, docs[10:20])
    precision_40_50 = measure_precision(pipeline, docs[40:50])

    # Quality should improve
    assert precision_40_50 > precision_0_10
    assert precision_10_20 > precision_0_10
```

## Production Readiness Validation

**ALL gates must be GREEN before deployment:**

```python
class ProductionReadinessValidation:
    def validate_all_gates(self) -> bool:
        gates = {
            "temporal_extraction": self.validate_temporal_accuracy() > 0.85,
            "schema_evolution": self.validate_schema_alignment() > 0.90,
            "extraction_quality": self.validate_precision() >= 0.8,
            "experiential_learning": self.validate_quality_improvement(),
            "thought_templates": self.validate_template_evolution(),
            "causal_structure": self.validate_event_extraction() > 0.80,
            "performance": self.validate_throughput() > 5,
            "privacy": self.validate_privacy_compliance(),
            "error_handling": self.validate_quarantine_workflow(),
            "integration": self.validate_end_to_end_pipeline()
        }

        return all(gates.values())
```

## Test Coverage Requirements

- **Unit tests**: >80% coverage for extraction logic
- **Integration tests**: All pipeline stages covered
- **Performance tests**: Throughput, latency, memory validated
- **Quality tests**: Precision, recall, temporal accuracy measured
- **Learning tests**: Quality progression demonstrated

## References

- **Production Plans**: [docs/phase-1/entity-relationship-extraction-production-plan/06-integration-testing.md](mdc:docs/phase-1/entity-relationship-extraction-production-plan/06-integration-testing.md)
- **Quality Targets**: [docs/phase-1/PHASE-1-OPTION-B-ROADMAP.md](mdc:docs/phase-1/PHASE-1-OPTION-B-ROADMAP.md)
